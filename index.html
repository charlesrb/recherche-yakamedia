<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yakamedia Search</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .index-selector {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .index-btn {
            background: white;
            border: 2px solid #ffc200;
            color: #ffc200;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .index-btn:hover {
            background: #ffc200;
            color: white;
            transform: translateY(-2px);
        }
        
        .index-btn.active {
            background: #ffc200;
            color: white;
        }
        
        .search-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ffc200;
        }
        
        .btn {
            background: #ffc200;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn:hover {
            background: #e6ac00;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            font-size: 0.9em;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #ffc200;
        }
        
        .clear-filters-btn {
            background: #6c757d;
            font-size: 0.9em;
            padding: 8px 15px;
            margin-top: 20px;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
        }
        
        .results {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c66;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .results-info {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        .resource-list {
            display: grid;
            gap: 15px;
        }
        
        .resource-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 15px;
        }
        
        .resource-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .resource-header {
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }
        
        .resource-id {
            background: #ffc200;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-family: monospace;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .resource-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .resource-details {
            display: grid;
            gap: 8px;
        }
        
        .field-row {
            display: flex;
            padding: 6px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .field-row:last-child {
            border-bottom: none;
        }
        
        .field-row strong {
            min-width: 180px;
            color: #555;
            font-size: 0.9em;
        }
        
        .field-value {
            color: #333;
            flex: 1;
            font-size: 0.9em;
            word-break: break-word;
        }
        
        .resource-meta {
            color: #666;
            font-size: 0.9em;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Yakamedia Search</h1>
            <p>Recherchez dans les ressources Mediasheets et Universes</p>
        </div>
        
        <div class="controls">
            <div class="index-selector">
                <button class="index-btn active" data-index="mediasheets">üìÑ Mediasheets</button>
                <button class="index-btn" data-index="universes">üåç Universes</button>
            </div>
            
            <div class="search-controls">
                <input type="text" class="search-input" placeholder="Rechercher par titre..." id="searchInput">
                <button class="btn" id="searchBtn">Rechercher</button>
                <button class="btn" id="listAllBtn">Lister tout</button>
                <button class="btn" id="exportBtn" style="display: none;">Exporter CSV</button>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Auteur</label>
                        <select class="filter-select" id="authorFilter">
                            <option value="">Tous les auteurs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Cat√©gorie</label>
                        <select class="filter-select" id="categoryFilter">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sous-cat√©gorie</label>
                        <select class="filter-select" id="subcategoryFilter">
                            <option value="">Toutes les sous-cat√©gories</option>
                        </select>
                    </div>
                    <button class="btn clear-filters-btn" id="clearFiltersBtn">Effacer filtres</button>
                </div>
            </div>
        </div>
        
        <div class="results" id="results"></div>
    </div>

    <script>
        // Configuration API
        const API_CONFIG = {
            baseURL: 'https://meilisearch.app.yakamedia.cemea.asso.fr',
            token: '9752acd92656578cf206bc6669a40f56fe35a73898efb00fb0e5d33f44546cb4',
            headers: {
                'Authorization': 'Bearer 9752acd92656578cf206bc6669a40f56fe35a73898efb00fb0e5d33f44546cb4',
                'Content-Type': 'application/json'
            }
        };

        // Variables globales
        let currentIndex = 'mediasheets';
        let currentResults = [];
        let currentOffset = 0;
        let totalResults = 0;
        let isListingAll = false;
        const resultsContainer = document.getElementById('results');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const listAllBtn = document.getElementById('listAllBtn');

        // Gestion des boutons
        const exportBtn = document.getElementById('exportBtn');
        
        // Gestion des boutons d'index
        document.querySelectorAll('.index-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('.index-btn.active').classList.remove('active');
                btn.classList.add('active');
                currentIndex = btn.dataset.index;
                clearResults();
                clearFilters();
                loadFiltersData(); // Charger les donn√©es pour les filtres
            });
        });

        // Gestion de la recherche
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // Gestion du listing complet
        listAllBtn.addEventListener('click', () => listAllDocuments(0));
        
        // Gestion de l'export CSV
        exportBtn.addEventListener('click', exportToCSV);
        
        // Gestion des filtres
        authorFilter.addEventListener('change', applyFilters);
        categoryFilter.addEventListener('change', applyFilters);
        subcategoryFilter.addEventListener('change', applyFilters);
        clearFiltersBtn.addEventListener('click', clearFilters);

        // Fonction de recherche
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                alert('Veuillez saisir un terme de recherche');
                return;
            }

            showLoading();
            disableButtons();
            isListingAll = false;

            try {
                const url = `${API_CONFIG.baseURL}/indexes/${currentIndex}/search?q=${encodeURIComponent(query)}`;
                // Tentative directe d'abord
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: API_CONFIG.headers
                    });
                } catch (corsError) {
                    console.log('Erreur CORS, utilisation du proxy...');
                    // Utiliser un proxy CORS si la requ√™te directe √©choue
                    response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': API_CONFIG.headers.Authorization
                        }
                    });
                }

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentResults = data.hits || data.results || [];
                totalResults = data.estimatedTotalHits || data.totalHits || currentResults.length;
                
                // Alimenter les filtres avec les nouvelles donn√©es
                populateFilters(currentResults);
                
                displayResults(data, `R√©sultats de recherche pour "${query}"`);
                showExportButton();
            } catch (error) {
                showError(`Erreur lors de la recherche: ${error.message}`);
            } finally {
                enableButtons();
            }
        }

        // Fonction de listing complet avec pagination
        async function listAllDocuments(offset = 0) {
            showLoading();
            disableButtons();
            isListingAll = true;
            currentOffset = offset;

            try {
                const limit = 100; // Batch de 100 √©l√©ments
                const url = `${API_CONFIG.baseURL}/indexes/${currentIndex}/documents?offset=${offset}&limit=${limit}`;
                
                // Tentative directe d'abord
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: API_CONFIG.headers
                    });
                } catch (corsError) {
                    console.log('Erreur CORS, utilisation du proxy...');
                    // Utiliser un proxy CORS si la requ√™te directe √©choue
                    response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': API_CONFIG.headers.Authorization
                        }
                    });
                }

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Mettre √† jour les r√©sultats et pagination
                if (offset === 0) {
                    currentResults = data.results || [];
                    totalResults = data.total || currentResults.length;
                    // Alimenter les filtres avec les nouvelles donn√©es
                    populateFilters(currentResults);
                } else {
                    const newResults = data.results || [];
                    currentResults = [...currentResults, ...newResults];
                    // Mettre √† jour les filtres avec toutes les donn√©es accumul√©es
                    populateFilters(currentResults);
                }
                
                displayResultsWithPagination(data, offset, limit);
                showExportButton();
            } catch (error) {
                showError(`Erreur lors du chargement: ${error.message}`);
            } finally {
                enableButtons();
            }
        }

        // Affichage des r√©sultats avec pagination
        function displayResultsWithPagination(data, offset, limit) {
            const results = data.results || [];
            const total = data.total || results.length;
            const currentPage = Math.floor(offset / limit) + 1;
            const totalPages = Math.ceil(total / limit);
            const showingStart = offset + 1;
            const showingEnd = Math.min(offset + results.length, total);

            // Contr√¥les de pagination
            const paginationControls = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        <strong>Page ${currentPage} sur ${totalPages}</strong><br>
                        Affichage de ${showingStart} √† ${showingEnd} sur ${total} documents
                        dans l'index <em>${currentIndex}</em>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        ${offset > 0 ? `<button onclick="listAllDocuments(${Math.max(0, offset - limit)})" class="btn">‚Üê Pr√©c√©dent</button>` : ''}
                        ${offset + limit < total ? `<button onclick="listAllDocuments(${offset + limit})" class="btn">Suivant ‚Üí</button>` : ''}
                        ${total > limit ? `<button onclick="loadAllDocuments()" class="btn" style="background: #28a745;">Tout charger (${total})</button>` : ''}
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = `
                ${paginationControls}
                <div class="resource-list">
                    ${results.map(item => createResourceItem(item)).join('')}
                </div>
                ${totalPages > 1 ? paginationControls : ''}
            `;
        }

        // Charger tous les documents (attention: peut √™tre long)
        async function loadAllDocuments() {
            if (!confirm(`Voulez-vous vraiment charger tous les ${totalResults} documents ? Cela peut prendre du temps.`)) {
                return;
            }

            showLoading();
            disableButtons();

            try {
                currentResults = [];
                const limit = 100;
                const totalBatches = Math.ceil(totalResults / limit);

                for (let i = 0; i < totalBatches; i++) {
                    const offset = i * limit;
                    resultsContainer.innerHTML = `<div class="loading">üîÑ Chargement batch ${i + 1}/${totalBatches}... (${offset + 1}-${Math.min(offset + limit, totalResults)})</div>`;

                    const url = `${API_CONFIG.baseURL}/indexes/${currentIndex}/documents?offset=${offset}&limit=${limit}`;
                    
                    let response;
                    try {
                        response = await fetch(url, {
                            method: 'GET',
                            headers: API_CONFIG.headers
                        });
                    } catch (corsError) {
                        response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': API_CONFIG.headers.Authorization
                            }
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    currentResults = [...currentResults, ...(data.results || [])];

                    // Petite pause pour ne pas surcharger le serveur
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                resultsContainer.innerHTML = `
                    <div class="results-info">
                        <strong>Tous les documents charg√©s !</strong><br>
                        ${currentResults.length} documents dans l'index <em>${currentIndex}</em>
                    </div>
                    <div class="resource-list">
                        ${currentResults.map(item => createResourceItem(item)).join('')}
                    </div>
                `;

                showExportButton();
            } catch (error) {
                showError(`Erreur lors du chargement complet: ${error.message}`);
            } finally {
                enableButtons();
            }
        }

        // Charger les donn√©es pour alimenter les filtres
        async function loadFiltersData() {
            try {
                // Charger un √©chantillon pour extraire les filtres possibles
                const url = `${API_CONFIG.baseURL}/indexes/${currentIndex}/documents?offset=0&limit=100`;
                let response;
                try {
                    response = await fetch(url, {
                        method: 'GET',
                        headers: API_CONFIG.headers
                    });
                } catch (corsError) {
                    response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': API_CONFIG.headers.Authorization
                        }
                    });
                }

                if (response.ok) {
                    const data = await response.json();
                    populateFilters(data.results || []);
                }
            } catch (error) {
                console.log('Erreur lors du chargement des donn√©es de filtres:', error);
            }
        }

        // Alimenter les listes d√©roulantes des filtres
        function populateFilters(results) {
            allAuthors.clear();
            allCategories.clear();
            allSubcategories.clear();

            results.forEach(item => {
                const attrs = item.attributes || {};
                
                // Auteurs
                if (attrs.field_author && Array.isArray(attrs.field_author)) {
                    attrs.field_author.forEach(author => {
                        if (author.attributes?.display_name) {
                            allAuthors.add(author.attributes.display_name);
                        }
                    });
                }
                
                // Cat√©gories
                if (attrs.field_category && Array.isArray(attrs.field_category)) {
                    attrs.field_category.forEach(cat => {
                        if (cat.attributes?.name) {
                            allCategories.add(cat.attributes.name);
                        }
                    });
                }
                
                // Sous-cat√©gories
                if (attrs.field_bafa_category && Array.isArray(attrs.field_bafa_category)) {
                    attrs.field_bafa_category.forEach(subcat => {
                        if (subcat.attributes?.name) {
                            allSubcategories.add(subcat.attributes.name);
                        }
                    });
                }
            });

            // Mettre √† jour les selects
            updateFilterSelect(authorFilter, Array.from(allAuthors).sort());
            updateFilterSelect(categoryFilter, Array.from(allCategories).sort());
            updateFilterSelect(subcategoryFilter, Array.from(allSubcategories).sort());
        }

        // Mettre √† jour un select avec des options
        function updateFilterSelect(selectElement, options) {
            // Conserver la premi√®re option (Tous...)
            const firstOption = selectElement.children[0];
            selectElement.innerHTML = '';
            selectElement.appendChild(firstOption);
            
            // Ajouter les nouvelles options
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
        }

        // Appliquer les filtres aux r√©sultats actuels
        function applyFilters() {
            if (!currentResults.length) return;

            const authorValue = authorFilter.value;
            const categoryValue = categoryFilter.value;
            const subcategoryValue = subcategoryFilter.value;

            const filteredResults = currentResults.filter(item => {
                const attrs = item.attributes || {};
                
                // Filtre auteur
                if (authorValue) {
                    const authors = attrs.field_author || [];
                    const hasAuthor = authors.some(author => 
                        author.attributes?.display_name === authorValue
                    );
                    if (!hasAuthor) return false;
                }
                
                // Filtre cat√©gorie
                if (categoryValue) {
                    const categories = attrs.field_category || [];
                    const hasCategory = categories.some(cat => 
                        cat.attributes?.name === categoryValue
                    );
                    if (!hasCategory) return false;
                }
                
                // Filtre sous-cat√©gorie
                if (subcategoryValue) {
                    const subcategories = attrs.field_bafa_category || [];
                    const hasSubcategory = subcategories.some(subcat => 
                        subcat.attributes?.name === subcategoryValue
                    );
                    if (!hasSubcategory) return false;
                }
                
                return true;
            });

            // Afficher les r√©sultats filtr√©s
            displayFilteredResults(filteredResults);
        }

        // Afficher les r√©sultats filtr√©s
        function displayFilteredResults(filteredResults) {
            const activeFilters = [];
            if (authorFilter.value) activeFilters.push(`Auteur: ${authorFilter.value}`);
            if (categoryFilter.value) activeFilters.push(`Cat√©gorie: ${categoryFilter.value}`);
            if (subcategoryFilter.value) activeFilters.push(`Sous-cat√©gorie: ${subcategoryFilter.value}`);
            
            const filterInfo = activeFilters.length > 0 ? ` (Filtres actifs: ${activeFilters.join(', ')})` : '';
            
            resultsContainer.innerHTML = `
                <div class="results-info">
                    <strong>R√©sultats filtr√©s</strong>${filterInfo}<br>
                    ${filteredResults.length} r√©sultat(s) affich√©(s) sur ${currentResults.length} total
                    dans l'index <em>${currentIndex}</em>
                </div>
                <div class="resource-list">
                    ${filteredResults.map(item => createResourceItem(item)).join('')}
                </div>
            `;
        }

        // Effacer tous les filtres
        function clearFilters() {
            authorFilter.selectedIndex = 0;
            categoryFilter.selectedIndex = 0;
            subcategoryFilter.selectedIndex = 0;
            
            // R√©afficher tous les r√©sultats si on en a
            if (currentResults.length > 0) {
                const title = isListingAll ? 'Liste compl√®te des documents' : 'R√©sultats de recherche';
                displayResults({ results: currentResults, total: totalResults }, title);
            }
        }

        // Fonction pour calculer le nombre total de caract√®res des field_body
        function calculateTotalBodyCharacters(attrs) {
            let totalChars = 0;
            
            // Parcourir field_media_block pour trouver tous les field_body
            if (attrs.field_media_block && Array.isArray(attrs.field_media_block)) {
                attrs.field_media_block.forEach(block => {
                    if (block.attributes && block.attributes.field_body) {
                        const bodyContent = block.attributes.field_body;
                        if (typeof bodyContent === 'string') {
                            // Nettoyer le HTML pour ne compter que le texte
                            const textContent = bodyContent.replace(/<[^>]*>/g, '').trim();
                            totalChars += textContent.length;
                        } else if (bodyContent.value) {
                            // Si c'est un objet avec une propri√©t√© value
                            const textContent = bodyContent.value.replace(/<[^>]*>/g, '').trim();
                            totalChars += textContent.length;
                        }
                    }
                });
            }
            
            return totalChars;
        }

        // Cr√©ation d'un √©l√©ment de ressource
        function createResourceItem(item) {
            const attrs = item.attributes || {};
            
            // Extraction des informations principales
            const id = item.id || 'N/A';
            const titre = attrs.title || 'Titre non disponible';
            
            // Auteurs - extraction depuis field_author (array d'objets utilisateur)
            let auteur1 = 'N/A', auteur2 = 'N/A', auteur3 = 'N/A';
            if (attrs.field_author && Array.isArray(attrs.field_author)) {
                auteur1 = attrs.field_author[0]?.attributes?.display_name || attrs.field_author[0]?.attributes?.name || 'N/A';
                auteur2 = attrs.field_author[1]?.attributes?.display_name || attrs.field_author[1]?.attributes?.name || 'N/A';
                auteur3 = attrs.field_author[2]?.attributes?.display_name || attrs.field_author[2]?.attributes?.name || 'N/A';
            }
            
            // Date de mise en ligne
            const dateMiseEnLigne = attrs.created || 'N/A';
            const formattedDate = dateMiseEnLigne !== 'N/A' ? new Date(dateMiseEnLigne).toLocaleDateString('fr-FR') : 'N/A';
            
            // Cat√©gorie - depuis field_category (array d'objets taxonomie)
            let categorie = 'N/A';
            if (attrs.field_category && Array.isArray(attrs.field_category) && attrs.field_category[0]) {
                categorie = attrs.field_category[0].attributes?.name || 'N/A';
            }
            
            // Sous-cat√©gorie - depuis field_bafa_category
            let sousCategorie = 'N/A';
            if (attrs.field_bafa_category && Array.isArray(attrs.field_bafa_category) && attrs.field_bafa_category[0]) {
                sousCategorie = attrs.field_bafa_category[0].attributes?.name || 'N/A';
            }
            
            // Chemin d'acc√®s complet
            const cheminAcces = attrs.path?.alias || 'N/A';
            
            // URL - depuis les metatags canonical
            let url = 'N/A';
            if (attrs.metatag && Array.isArray(attrs.metatag)) {
                const canonicalTag = attrs.metatag.find(tag => 
                    tag.tag === 'link' && tag.attributes?.rel === 'canonical'
                );
                if (canonicalTag) {
                    url = canonicalTag.attributes.href;
                }
            }
            
            // Nombre de caract√®res (comptabiliser tous les field_body)
            const nbCaracteres = calculateTotalBodyCharacters(attrs);
            
            // Attributs suppl√©mentaires - prendre des champs int√©ressants
            const attributsInteressants = [];
            
            // Attribut 1: Introduction/Chapo
            if (attrs.field_intro) {
                attributsInteressants.push(`<div class="field-row"><strong>Attribut 1 (intro):</strong> <span class="field-value">${attrs.field_intro.substring(0, 80)}${attrs.field_intro.length > 80 ? '...' : ''}</span></div>`);
            }
            
            // Attribut 2: Date de publication
            if (attrs.field_publication_date) {
                const pubDate = new Date(attrs.field_publication_date).toLocaleDateString('fr-FR');
                attributsInteressants.push(`<div class="field-row"><strong>Attribut 2 (publication):</strong> <span class="field-value">${pubDate}</span></div>`);
            }
            
            // Attribut 3: Attributs/tags (field_attribute)
            if (attrs.field_attribute && Array.isArray(attrs.field_attribute) && attrs.field_attribute.length > 0) {
                const tags = attrs.field_attribute.slice(0, 3).map(attr => attr.attributes?.name).filter(Boolean).join(', ');
                if (tags) {
                    attributsInteressants.push(`<div class="field-row"><strong>Attribut 3 (tags):</strong> <span class="field-value">${tags}</span></div>`);
                }
            }
            
            // Si pas assez d'attributs, en ajouter d'autres
            while (attributsInteressants.length < 3) {
                const remainingFields = Object.entries(attrs)
                    .filter(([key, value]) => 
                        !['title', 'created', 'field_author', 'field_category', 'field_bafa_category', 
                          'path', 'metatag', 'field_intro', 'field_publication_date', 'field_attribute',
                          'drupal_internal__nid', 'drupal_internal__vid', 'langcode', 'revision_timestamp', 
                          'status', 'changed', 'promote', 'sticky', 'default_langcode'].includes(key) &&
                        value !== null && value !== undefined && value !== '' && value !== false
                    );
                
                if (remainingFields.length > attributsInteressants.length) {
                    const [key, value] = remainingFields[attributsInteressants.length];
                    let displayValue = value;
                    if (typeof value === 'object') {
                        displayValue = JSON.stringify(value).substring(0, 60) + '...';
                    } else if (typeof value === 'string' && value.length > 60) {
                        displayValue = value.substring(0, 60) + '...';
                    }
                    const cleanKey = key.replace('field_', '').replace('drupal_internal__', '');
                    attributsInteressants.push(`<div class="field-row"><strong>Attribut ${attributsInteressants.length + 1} (${cleanKey}):</strong> <span class="field-value">${displayValue}</span></div>`);
                } else {
                    break;
                }
            }

            return `
                <div class="resource-item">
                    <div class="resource-header">
                        <div class="resource-id">ID: ${id}</div>
                        <div class="resource-title">${titre}</div>
                    </div>
                    <div class="resource-details">
                        <div class="field-row"><strong>Auteur 1:</strong> <span class="field-value">${auteur1}</span></div>
                        <div class="field-row"><strong>Auteur 2:</strong> <span class="field-value">${auteur2}</span></div>
                        <div class="field-row"><strong>Auteur 3:</strong> <span class="field-value">${auteur3}</span></div>
                        <div class="field-row"><strong>Date de mise en ligne:</strong> <span class="field-value">${formattedDate}</span></div>
                        <div class="field-row"><strong>Cat√©gorie:</strong> <span class="field-value">${categorie}</span></div>
                        <div class="field-row"><strong>Sous cat√©gorie:</strong> <span class="field-value">${sousCategorie}</span></div>
                        <div class="field-row"><strong>Chemin d'acc√®s complet:</strong> <span class="field-value">${cheminAcces}</span></div>
                        ${attributsInteressants.join('')}
                        <div class="field-row"><strong>URL:</strong> <span class="field-value">${url}</span></div>
                        <div class="field-row"><strong>Nombre de caract√®res:</strong> <span class="field-value">${nbCaracteres}</span></div>
                    </div>
                </div>
            `;
        }

        // Affichage des r√©sultats (pour recherche)
        function displayResults(data, title) {
            let results = data.hits || data.results || data;
            if (!Array.isArray(results)) {
                results = [data];
            }

            const resultsCount = results.length;
            const totalCount = data.estimatedTotalHits || data.totalHits || resultsCount;

            resultsContainer.innerHTML = `
                <div class="results-info">
                    <strong>${title}</strong><br>
                    ${resultsCount} r√©sultat(s) affich√©(s)${totalCount !== resultsCount ? ` sur ${totalCount} total` : ''}
                    dans l'index <em>${currentIndex}</em>
                </div>
                <div class="resource-list">
                    ${results.map(item => createResourceItem(item)).join('')}
                </div>
            `;
        }

        // Export CSV
        function exportToCSV() {
            if (!currentResults.length) {
                alert('Aucun r√©sultat √† exporter');
                return;
            }

            // En-t√™tes CSV
            const headers = [
                'ID',
                'Titre',
                'Auteur 1',
                'Auteur 2', 
                'Auteur 3',
                'Date de mise en ligne',
                'Cat√©gorie',
                'Sous cat√©gorie',
                'Chemin d\'acc√®s complet',
                'Introduction',
                'Date de publication',
                'Tags',
                'URL',
                'Nombre de caract√®res'
            ];

            // Conversion des donn√©es
            const csvData = currentResults.map(item => {
                const attrs = item.attributes || {};
                
                // Extraction des m√™mes donn√©es que l'affichage
                const id = item.id || '';
                const titre = attrs.title || '';
                
                let auteur1 = '', auteur2 = '', auteur3 = '';
                if (attrs.field_author && Array.isArray(attrs.field_author)) {
                    auteur1 = attrs.field_author[0]?.attributes?.display_name || '';
                    auteur2 = attrs.field_author[1]?.attributes?.display_name || '';
                    auteur3 = attrs.field_author[2]?.attributes?.display_name || '';
                }
                
                const dateMiseEnLigne = attrs.created ? new Date(attrs.created).toLocaleDateString('fr-FR') : '';
                
                let categorie = '';
                if (attrs.field_category && Array.isArray(attrs.field_category) && attrs.field_category[0]) {
                    categorie = attrs.field_category[0].attributes?.name || '';
                }
                
                let sousCategorie = '';
                if (attrs.field_bafa_category && Array.isArray(attrs.field_bafa_category) && attrs.field_bafa_category[0]) {
                    sousCategorie = attrs.field_bafa_category[0].attributes?.name || '';
                }
                
                const cheminAcces = attrs.path?.alias || '';
                const introduction = attrs.field_intro || '';
                const datePublication = attrs.field_publication_date ? new Date(attrs.field_publication_date).toLocaleDateString('fr-FR') : '';
                
                let tags = '';
                if (attrs.field_attribute && Array.isArray(attrs.field_attribute)) {
                    tags = attrs.field_attribute.map(attr => attr.attributes?.name).filter(Boolean).join(', ');
                }
                
                let url = '';
                if (attrs.metatag && Array.isArray(attrs.metatag)) {
                    const canonicalTag = attrs.metatag.find(tag => 
                        tag.tag === 'link' && tag.attributes?.rel === 'canonical'
                    );
                    if (canonicalTag) {
                        url = canonicalTag.attributes.href;
                    }
                }
                
                const nbCaracteres = calculateTotalBodyCharacters(attrs);

                return [
                    id,
                    titre,
                    auteur1,
                    auteur2,
                    auteur3,
                    dateMiseEnLigne,
                    categorie,
                    sousCategorie,
                    cheminAcces,
                    introduction,
                    datePublication,
                    tags,
                    url,
                    nbCaracteres
                ].map(field => `"${String(field || '').replace(/"/g, '""')}"`);
            });

            // Construction du CSV
            const csvContent = [headers.map(h => `"${h}"`), ...csvData]
                .map(row => row.join(','))
                .join('\n');

            // T√©l√©chargement
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
            const searchType = isListingAll ? 'listing' : 'search';
            link.setAttribute('download', `yakamedia_${currentIndex}_${searchType}_${timestamp}.csv`);
            
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Afficher le bouton d'export
        function showExportButton() {
            exportBtn.style.display = 'inline-block';
        }

        // Fonctions utilitaires
        function showLoading() {
            resultsContainer.innerHTML = '<div class="loading">üîÑ Chargement en cours...</div>';
        }

        function showError(message) {
            resultsContainer.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }

        function clearResults() {
            resultsContainer.innerHTML = '';
            currentResults = [];
            exportBtn.style.display = 'none';
        }

        function disableButtons() {
            searchBtn.disabled = true;
            listAllBtn.disabled = true;
            exportBtn.disabled = true;
        }

        function enableButtons() {
            searchBtn.disabled = false;
            listAllBtn.disabled = false;
            exportBtn.disabled = false;
        }

        // Message initial et initialisation
        resultsContainer.innerHTML = '<div class="loading">üöÄ Pr√™t √† rechercher ! Utilisez les boutons ci-dessus pour commencer.</div>';
        
        // Charger les donn√©es de filtres au d√©marrage
        loadFiltersData();
    </script>
</body>
</html>